---
- name: Mostrar usuarios y permisos en Linux y Windows (solo no-servicio)
  hosts: semaforos
  gather_facts: yes
  become: true

  vars:
    # Linux: la mayoría de distros reservan UIDs <1000 para cuentas de sistema
    min_uid: 1000
    # Windows: añade aquí patrones propios (p.ej. ^svc_ ). Se excluyen integradas por SID aparte.
    windows_exclude_regex: '^(DefaultAccount|WDAGUtilityAccount|Guest|Administrator)$'
    # Si quieres excluir también los que nunca iniciaron sesión en Windows, pon esto en true
    windows_exclude_never_logged: false

  tasks:
    - name: Detectar si el sistema es Windows
      set_fact:
        es_windows: "{{ ansible_os_family == 'Windows' }}"

    # ---------- LINUX ----------
    - name: Obtener usuarios "humanos" en Linux (UID >= min_uid y shell de login)
      when: not es_windows
      shell: |
        echo "Usuarios de login (no de servicio):"
        getent passwd | awk -F: '($3 >= {{ min_uid }}) && ($7 !~ /(\/usr\/sbin\/nologin|\/sbin\/nologin|\/bin\/false)/) { printf "%s (UID: %s, GID: %s, Shell: %s)\n", $1,$3,$4,$7 }'
        echo ""
        echo "Grupos con GID >= {{ min_uid }}:"
        getent group | awk -F: '$3 >= {{ min_uid }} { print $0 }'
      register: salida_linux
      args:
        executable: /bin/bash
      changed_when: false

    - name: Mostrar resultado Linux en consola
      when: not es_windows
      debug:
        msg: "{{ salida_linux.stdout_lines }}"

    # ---------- WINDOWS ----------
    - name: Obtener usuarios "humanos" en Windows (excluir integrados/servicio)
      when: es_windows
      win_shell: |
        # RIDs integrados: 500=Administrator, 501=Guest, 503=DefaultAccount, 504=WDAGUtilityAccount
        $builtInRIDs = @('500','501','503','504')

        $usuarios = Get-LocalUser |
          Where-Object {
            $_.Enabled -eq $true -and
            ($builtInRIDs -notcontains (($_.SID.Value -split '-')[-1])) -and
            ($_.Name -notmatch '{{ windows_exclude_regex }}')
          }

        if ({{ windows_exclude_never_logged | lower }}) {
          $usuarios = $usuarios | Where-Object { $_.LastLogon -ne $null }
        }

        $usuarios = $usuarios | Select-Object Name, Enabled, LastLogon

        $gruposAdmin = Get-LocalGroupMember -Group 'Administrators' |
          Select-Object Name, ObjectClass

        "Usuarios locales (no servicio):`n" + ($usuarios | Format-Table -AutoSize | Out-String) +
        "`nMiembros del grupo Administrators:`n" + ($gruposAdmin | Format-Table -AutoSize | Out-String)
      register: salida_windows
      changed_when: false

    - name: Mostrar resultado Windows en consola
      when: es_windows
      debug:
        msg: "{{ salida_windows.stdout_lines }}"
