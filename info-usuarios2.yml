##########################################################
# 1) Recoger TODOS los usuarios y sus Grupos             #
##########################################################
- name: Recoger usuarios y permisos
  hosts: semaforos
  gather_facts: yes
  become: true
  vars:
    ruta_json_remoto: "/tmp/info_{{ inventory_hostname }}.json"
    ruta_json_ctl:    "/home/semaphore/Excels"

  pre_tasks:
    - name: Limpieza inicial de JSONs
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_fileglob: ["{{ ruta_json_ctl }}/info_*.json"]
      delegate_to: localhost
      run_once: true
      become: false

  tasks:
    - name: Detectar SO
      ansible.builtin.set_fact:
        es_windows: "{{ ansible_os_family == 'Windows' }}"

    - name: Linux - Obtener todos los usuarios y sus grupos
      when: not es_windows
      ansible.builtin.shell: |
        for u in $(cut -d: -f1 /etc/passwd); do
          groups_list=$(id -Gn $u | tr ' ' ',')
          echo "$u:$groups_list"
        done
      register: datos_linux
      changed_when: false

    - name: Windows - Obtener todos los usuarios y sus grupos
      when: es_windows
      ansible.windows.win_shell: |
        Get-LocalUser | ForEach-Object {
            $name = $_.Name
            $groups = (Get-LocalGroup | Where-Object { (Get-LocalGroupMember -Group $_.Name).Name -contains "$env:COMPUTERNAME\$name" }).Name
            "$name:$($groups -join ',')"
        }
      register: datos_windows
      changed_when: false

    - name: Generar JSON
      ansible.builtin.copy:
        dest: "{{ ruta_json_remoto }}"
        content: |
          {
            "inventory_hostname": "{{ inventory_hostname }}",
            "datos": {{ (es_windows | ternary(datos_windows.stdout_lines, datos_linux.stdout_lines)) | to_json }}
          }

    - name: Descargar JSON al controlador
      ansible.builtin.fetch:
        src: "{{ ruta_json_remoto }}"
        dest: "{{ ruta_json_ctl }}/"
        flat: true

##########################################################
# 2) Localhost: Crear Excel con columna "Permisos"       #
##########################################################
- name: Procesar datos y generar Excel
  hosts: localhost
  gather_facts: no
  vars:
    ruta_json_ctl: "/home/semaphore/Excels"
    ruta_excel:    "/home/semaphore/Excels/Inventario_Usuarios_Completo.xlsx"
    script_python: "/home/semaphore/Excels/append_excel2.py"
    venv_path:     "/home/semaphore/Excels/.venv"

  tasks:
    - name: Actualizar Script Python (Columna Permisos)
      ansible.builtin.copy:
        dest: "{{ script_python }}"
        mode: "0755"
        content: |
          #!/usr/bin/env python3
          import sys, os, json
          from openpyxl import Workbook, load_workbook

          def run():
              ex_p, j_p = sys.argv[1], sys.argv[2]
              with open(j_p, 'r') as f:
                  data = json.load(f)
              
              hn = data.get('inventory_hostname', 'Desconocido')
              filas = data.get('datos', [])

              if os.path.exists(ex_p):
                  wb = load_workbook(ex_p)
                  ws = wb.active
              else:
                  wb = Workbook()
                  ws = wb.active
                  # AQU√ç HEMOS CAMBIADO EL NOMBRE DE LA COLUMNA
                  ws.append(["Hostname", "Usuario", "Permisos"])

              for linea in filas:
                  if ':' in linea:
                      user, groups = linea.split(':', 1)
                      ws.append([hn, user, groups if groups else "sin grupos"])
              
              wb.save(ex_p)

          if __name__ == "__main__":
              run()

    - name: Ejecutar script para cada JSON
      ansible.builtin.shell: |
        [ -d {{ venv_path }} ] || python3 -m venv {{ venv_path }}
        {{ venv_path }}/bin/pip install openpyxl --quiet
        {{ venv_path }}/bin/python {{ script_python }} {{ ruta_excel }} {{ item }}
      with_fileglob:
        - "{{ ruta_json_ctl }}/info_*.json"

##########################################################
# 3) Copiar al recurso de red                            #
##########################################################
- name: Exportar Inventario Final
  hosts: localhost
  tasks:
    - name: Copiar Excel al Share
      become: true
      ansible.builtin.copy:
        src: "/home/semaphore/Excels/Inventario_Usuarios_Completo.xlsx"
        dest: "/mnt/ansible_share/Inventario_Usuarios.xlsx"
        mode: "0644"
        remote_src: true
